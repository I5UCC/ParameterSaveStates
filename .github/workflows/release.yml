name: Build and Release

on:
  push:
    tags:
      - '*'

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Unity Project (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-StandaloneWindows64-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-StandaloneWindows64-
            Library-

      - name: Create Library folder if missing
        run: if (!(Test-Path Library)) { New-Item -ItemType Directory -Path Library }
        shell: pwsh

      - name: Build Unity project
        uses: game-ci/unity-builder@v4
        env:
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: StandaloneWindows64
          buildName: ParameterSaveStates
          buildsPath: build

      - name: Create app.vrmanifest in build directory
        run: |
          $manifest = @'
          {
          	"source": "builtin",
          	"applications": [
          		{
          			"app_key": "i5ucc.parametersavestates",
          			"launch_type": "binary",
          			"binary_path_windows": "./ParameterSaveStates.exe",
          			"is_dashboard_overlay": true,

          			"strings": {
          				"en_us": { 
          					"name": "ParameterSaveStates",
          					"description": "ParameterSaveStates for VRChat Avatars"
          				}
          			}
          		}
          	]
          }
          '@
          $manifest -replace '(?m)^          ', '' | Set-Content -Path build\StandaloneWindows64\app.vrmanifest -Encoding UTF8
        shell: pwsh

      - name: Create zip archive
        run: Compress-Archive -Path build\StandaloneWindows64\* -DestinationPath ParameterSaveStates.zip
        shell: pwsh

      - name: Create Inno Setup installer script
        run: |
          $TAG = "${{ github.ref_name }}"
          @"
          [Setup]
          AppName=ParameterSaveStates
          AppVersion=$TAG
          AppPublisher=i5ucc
          DefaultDirName={autopf}\ParameterSaveStates
          DefaultGroupName=ParameterSaveStates
          OutputDir=.
          OutputBaseFilename=ParameterSaveStates-Setup
          Compression=lzma2
          SolidCompression=yes
          ArchitecturesInstallIn64BitMode=x64compatible

          [Files]
          Source: "build\StandaloneWindows64\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\ParameterSaveStates"; Filename: "{app}\ParameterSaveStates.exe"
          Name: "{group}\Uninstall ParameterSaveStates"; Filename: "{uninstallexe}"
          Name: "{autodesktop}\ParameterSaveStates"; Filename: "{app}\ParameterSaveStates.exe"; Tasks: desktopicon

          [Tasks]
          Name: "desktopicon"; Description: "Create a desktop shortcut"; GroupDescription: "Additional icons:"

          [Run]
          Filename: "{app}\ParameterSaveStates.exe"; Description: "Launch ParameterSaveStates"; Flags: nowait postinstall skipifsilent
          "@ -replace '(?m)^          ', '' | Set-Content installer.iss
        shell: pwsh

      - name: Build installer with Inno Setup
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.4
        with:
          path: installer.iss

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            ParameterSaveStates.zip
            ParameterSaveStates-Setup.exe

  build-linux:
    name: Build Unity Project (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-StandaloneLinux64-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-StandaloneLinux64-
            Library-

      - name: Create Library folder if missing
        run: mkdir -p Library

      - name: Build Unity project
        uses: game-ci/unity-builder@v4
        env:
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: StandaloneLinux64
          buildName: ParameterSaveStates
          buildsPath: build

      - name: Create app.vrmanifest in build directory
        run: |
          cat > build/StandaloneLinux64/app.vrmanifest << 'EOF'
          {
          	"source": "builtin",
          	"applications": [
          		{
          			"app_key": "i5ucc.parametersavestates",
          			"launch_type": "binary",
          			"binary_path_linux": "./ParameterSaveStates",
          			"is_dashboard_overlay": true,

          			"strings": {
          				"en_us": {
          					"name": "ParameterSaveStates",
          					"description": "ParameterSaveStates for VRChat Avatars"
          				}
          			}
          		}
          	]
          }
          EOF
          sed -i 's/^          //' build/StandaloneLinux64/app.vrmanifest

      - name: Create zip archive
        run: cd build/StandaloneLinux64 && zip -r ../../ParameterSaveStates-Linux.zip .

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: ParameterSaveStates-Linux.zip

  release:
    name: Create GitHub Release
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-build

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-build

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ParameterSaveStates.zip
            ParameterSaveStates-Setup.exe
            ParameterSaveStates-Linux.zip
          generate_release_notes: false
